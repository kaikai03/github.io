<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/theme/css/foundation.min.css" media="all">
		<link rel="stylesheet" href="/theme/css/pygments.css" /> 
		<link rel="stylesheet" href="/theme/css/style.css" /> 
        <script type="text/javascript" src="/theme/js/modernizr.js"></script>
		<script type='text/javascript' src='/theme/js/jquery-1.11.1.min.js'></script>
	    <script type="text/javascript" src="/theme/js/damoo.min.js"></script>
		<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
        <script type="text/javascript">var js=document.createElement('script');js.setAttribute('src',(('https:' == document.location.protocol) ? ' https://' : ' http://')+'cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML');document.head.appendChild(js);</script>

		
        <link href='https://fonts.googleapis.com/css?family=Exo+2:400,300,700,300italic,400italic,700italic,900,900italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/lamboz.css" media="all">
        <title>Python with - kairens`s Blog</title>
        <meta charset="utf-8" />
        
</head>
<body onblur="leavePage()" onfocus="comebackPage()">
    <div class="pages">
        <ul>
            <li class="home"><a href="/index.html">Home</a></li>
            <li ><a href="/pages/about-me.html">About Me</a></li>
            <li ><a href="/pages/Python_Packages_2012_11_05_12_18.html">Python Packages</a></li>
        </ul>
    </div>

<div class="hp-header-inner">
    <div class="page-header">
        <div class="content-header">
            <div id="title-block">
            <h1>  <a href="/2014/Python_with_2014_02_08_20_31.html" rel="bookmark"
                    title="Permalink to Python with">Python with</a></h1>
            </div>
        </div>
    </div>
</div>
    <div class="content">
        <div class="data-holder">
        <div class="row">
           <div class="large-9 content-column column">
<div class="content-article">
    <header class="header-article">
        <div class="read-more">Posted on Sat 08 February 2014</div>
 
   </header>
    <section class='article'>
        
        <div class="entry-summary">
            <p>Python语法--with</p>
        </div>
    
        <div class="entry-content">
            <h2>with语句是什么？</h2>
<blockquote>
<p>Python’s with statement provides a very convenient way of dealing with the situation where you have to do a setup and teardown to make something happen. A very good example for this is the situation where you want to gain a handler to a file, read data from the file and the close the file handler.</p>
</blockquote>
<p>有一些任务，可能事先需要设置，事后做清理工作。对于这种场景，Python的with语句提供了一种非常方便的处理方式。一个很好的例子是文件处理，你需要获取一个文件句柄，从文件中读取数据，然后关闭文件句柄。</p>
<p>如果不用with语句，代码如下：</p>
<div class="highlight"><pre>file = open(&quot;/tmp/foo.txt&quot;)
data = file.read()
file.close()
</pre></div>


<p>这里有两个问题。一是可能忘记关闭文件句柄；二是文件读取数据发生异常，没有进行任何处理。下面是处理异常的加强版本：</p>
<div class="highlight"><pre>file = open(&quot;/tmp/foo.txt&quot;)
try:
    data = file.read()
finally:
    file.close()
</pre></div>


<p>虽然这段代码运行良好，但是太冗长了。这时候就是with一展身手的时候了。除了有更优雅的语法，with还可以很好的处理上下文环境产生的异常。下面是with版本的代码：</p>
<div class="highlight"><pre>with open(&quot;/tmp/foo.txt&quot;)
 as file:
    data = file.read()
</pre></div>


<h3>with如何工作？</h3>
<p>这看起来充满魔法，但不仅仅是魔法，Python对with的处理还很聪明。基本思想是with所求值的对象必须有一个__enter__()方法，一个__exit__()方法。</p>
<p>紧跟with后面的语句被求值后，返回对象的__enter__()方法被调用，这个方法的返回值将被赋值给as后面的变量。当with后面的代码块全部被执行完之后，将调用前面返回对象的__exit__()方法。</p>
<p>下面例子可以具体说明with如何工作：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre>#!/usr/bin/env
 python
#
 with_example01.py


class Sample:
    def __enter__(self):
        print &quot;In
 __enter__()&quot;
        return &quot;Foo&quot;

    def __exit__(self, type,
 value, trace):
        print &quot;In
 __exit__()&quot;


def get_sample():
    return Sample()


with
 get_sample() as sample:
    print &quot;sample:&quot;,
 sample
</pre></div>
</td></tr></table>

<p>运行代码，输出如下:</p>
<div class="highlight"><pre>bash-3.2$
 ./with_example01.py
In
 __enter__()
sample:
 Foo
In
 __exit__()
</pre></div>


<p>正如你看到的</p>
<ol>
<li>__enter__()方法被执行</li>
<li>__enter__()方法返回的值 - 这个例子中是"Foo"，赋值给变量'sample'</li>
<li>执行代码块，打印变量"sample"的值为 "Foo"</li>
<li>__exit__()方法被调用</li>
<li>with真正强大之处是它可以处理异常。可能你已经注意到Sample类的__exit__方法有三个参数- val, type 和 trace。 这些参数在异常处理中相当有用。我们来改一下代码，看看具体如何工作的。<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre>#!/usr/bin/env
 python
#
 with_example02.py

class Sample:
    def __enter__(self):
        return self

    def __exit__(self, type, value, trace):
        print &quot;type:&quot;, type
        print &quot;value:&quot;, value
        print &quot;trace:&quot;, trace

    def do_something(self):
        bar = 1/0
        return bar + 10
with
    Sample() as sample:
    sample.do_something()
</pre></div>
</td></tr></table>

</li>
</ol>
<p>这个例子中，with后面的get_sample()变成了Sample()。这没有任何关系，只要紧跟with后面的语句所返回的对象有__enter__()和__exit__()方法即可。此例中，Sample()的__enter__()方法返回新创建的Sample对象，并赋值给变量sample。</p>
<p>代码执行后：</p>
<div class="highlight"><pre>bash-3.2$
 ./with_example02.py
type:
 &lt;type &#39;exceptions.ZeroDivisionError&#39;&gt;
value:
 integer division or modulo
 by zero
trace:
 &lt;traceback object at 0x1004a8128&gt;
Traceback
 (most recent call last):
  File &quot;./with_example02.py&quot;,
 line 19, in &lt;module&gt;
    sample.do_something()
  File &quot;./with_example02.py&quot;,
 line 15, in do_something
    bar = 1/0
ZeroDivisionError:
 integer division or modulo
 by zero
</pre></div>


<p>实际上，在with后面的代码块抛出任何异常时，__exit__()方法被执行。正如例子所示，异常抛出时，与之关联的type，value和stack trace传给__exit__()方法，因此抛出的ZeroDivisionError异常被打印出来了。开发库时，清理资源，关闭文件等等操作，都可以放在__exit__方法当中。</p>
<p>因此，Python的with语句是提供一个有效的机制，让代码更简练，同时在异常产生时，清理工作更简单。</p>
        </div>
    </section>
    <footer class="footer-article">
        <div class="tags-and-categories">Filed under <a href="/category/pydev.html">pyDev</a>
        | Tagged: <a href="/tag/memory.html">Memory </a><a href="/tag/features.html">Features </a><a href="/tag/python.html">Python </a>
        | <a href="/2014/Python_with_2014_02_08_20_31.html" rel="bookmark"
         title="Permalink to Python with">Permalink</a>            
        </div>
        <!-- metaldata 
        -->
    </footer>
</div>
            </div>
            
            
			<div class="large-3 aside column">
				<img class="headIcon-large avatar" src="/sys_img/head.jpg" alt="(┬＿┬)">
                <h2>李凯</h2>
                <h3>kairens leeky</h3>
				<a href="mailto:kai_kai03@hotmail.com?subject=%20&body=from%20blog"><Email>kai_kai03@hotmail.com</Email></a>
            </div>
            
            
			
			<div class="large-3 aside column">
                <h3>Socials</h3>
                <ul>
                    <li><a href="http://weibo.com/mipamipami">新浪weibo</a></li>
                    <li><a href="#"> (ง •̀_•́)ง</a></li>
                </ul>
            </div> 
            
            <div class="large-3 category-column column">
                <h3>Categories</h3>
                <ul>
                    <li><a href="/category/db.html">DB</a> (3)</li>
                    <li><a href="/category/idev.html">iDev</a> (14)</li>
                    <li><a href="/category/machinelearning.html">MachineLearning</a> (18)</li>
                    <li><a href="/category/other.html">other</a> (2)</li>
                    <li class="active"><a href="/category/pydev.html">pyDev</a> (14)</li>
                    <li><a href="/category/yin-shi-pin.html">音视频</a> (15)</li>
                </ul>
            </div> 

                <!--
            <iframe width="100%" height="600" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=600&fansRow=1&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1819436507&verifier=4060feb2&colors=fc1f12,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>            </div>
            -->
         
    </div>
</div>
    <div class="footer">
        <div class="data-holder">
        <div class="row">
            <div class="large-3 column">
<div class="credits">
    <h3>Stuff and credits</h3>
    <p>
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, 
    which takes great advantage of <a href="http://python.org">Python</a>.
    </p>
    <p>
    This site also makes use of <a href="http://foundation.zurb.com">Zurb Foundation Framework</a>
    and is typeset using the blocky -- but quite good-looking indeed -- 
    <a href="https://www.google.com/fonts/specimen/Exo%202">Exo 2</a> fonts,
    which comes in a lot of weight and styles. 
    </p>
    <p>Enjoy!</a>
</div>           </div>
           <div class="large-6 tag-cloud column">
                <h3>Tags</h3>
                <ul class="tagcloud">
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/nao-dong.html">脑洞
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/websocket.html">WebSocket
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/mongo.html">mongo
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/classification.html">classification
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/shi-xu-tu.html">时序图
                        </a></li>
                    <li>
											<span class="badge">5</span>
                        <a href="/tag/chan-pin.html">产品
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/fuck.html">fuck
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/gc.html">GC
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/rtmp.html">RTMP
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/unicode.html">unicode
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/dylib.html">dylib
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/protocol.html">protocol
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/pycon.html">PyCon
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/cai-ji.html">采集
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/clustering.html">clustering
                        </a></li>
                    <li>
											<span class="badge">6</span>
                        <a href="/tag/web.html">Web
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/yi-zhi.html">移植
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/network.html">network
                        </a></li>
                    <li>
											<span class="badge">6</span>
                        <a href="/tag/flask.html">Flask
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/review.html">review
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/nodejs.html">Node.js
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/pep.html">PEP
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/features.html">Features
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/wu-tai.html">舞台
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/cnn.html">CNN
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/pca.html">PCA
                        </a></li>
                    <li>
											<span class="badge">6</span>
                        <a href="/tag/webrtc.html">webRtc
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/css.html">CSS
                        </a></li>
                    <li>
											<span class="badge">8</span>
                        <a href="/tag/object-c.html">Object-C
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/memory.html">Memory
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/life.html">life
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/flask-socketio.html">Flask-SocketIO
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/linear.html">Linear
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/dataprocessing.html">DataProcessing
                        </a></li>
                    <li>
											<span class="badge">16</span>
                        <a href="/tag/python.html">Python
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/javascript.html">JavaScript
                        </a></li>
                    <li>
											<span class="badge">16</span>
                        <a href="/tag/ios.html">iOS
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/encode.html">encode
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/xcode.html">xCode
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/appstore.html">appstore
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/html5.html">html5
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/liu-cheng.html">流程
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/uiimage.html">UIImage
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/ipad.html">iPad
                        </a></li>
                    <li>
											<span class="badge">5</span>
                        <a href="/tag/c.html">C++
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/audio.html">audio
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/ffmpeg.html">FFmpeg
                        </a></li>
                    <li>
											<span class="badge">15</span>
                        <a href="/tag/algorithm.html">algorithm
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/database.html">database
                        </a></li>
                    <li>
											<span class="badge">11</span>
                        <a href="/tag/ml.html">ML
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/yan-zou.html">演奏
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/framework.html">framework
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/gbk.html">GBK
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/rfc.html">rfc
                        </a></li>
                    <li>
											<span class="badge">12</span>
                        <a href="/tag/math.html">Math
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/jia-gou.html">架构
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/obs.html">OBS
                        </a></li>
                </ul>
            </div>

            <div class="large-3 aside column">
                <h3>Links</h3>
                <ul>
                    <li><a href="http://getpelican.com/">Pelican</a></li><br/>
                    <li><a href="http://python.org/">Python.org</a></li><br/>
                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li><br/>
                    <li><a href="#"> ฅ'ω'ฅ </a></li><br/>
                </ul>
                
            </div>

        </row>
        </div>
        <div class="row">
            <div class="small-12 column">
                <p style="font-size: 0.8em; text-align:center;">
                LEGO, the LEGO logo, the Minifigure, and the Brick and Knob configurations 
                are trademarks of the LEGO Group of Companies. ©2015.
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257347159'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1257347159%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
                </p>
            </div>
        </div>
    </div>

    
</body>
</html>