<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <link rel="stylesheet" href="/theme/css/foundation.min.css" media="all">
		<link rel="stylesheet" href="/theme/css/pygments.css" /> 
		<link rel="stylesheet" href="/theme/css/style.css" />
		<link rel="stylesheet" href="/theme/css/ukagaka.css" /> 
        <script type="text/javascript" src="/theme/js/modernizr.js"></script>
		<script type='text/javascript' src='/theme/js/jquery-1.11.1.min.js'></script>
	    <script type="text/javascript" src="/theme/js/damoo.min.js"></script>
		<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
        <script type="text/javascript">var js=document.createElement('script');js.setAttribute('src',(('https:' == document.location.protocol) ? ' https://' : ' http://')+'cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML');document.head.appendChild(js);</script>

        <link href='https://fonts.lug.ustc.edu.cn/css?family=Exo+2:400,300,700,300italic,400italic,700italic,900,900italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/lamboz.css" media="all">
        <title>Flask Web Development(7) - kairnsの记事簿</title>
        <meta charset="utf-8" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="kairnsの记事簿 Full Atom Feed" />
        <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="kairnsの记事簿 Full RSS Feed" />
        <link href="/feeds/pydev.atom.xml" type="application/atom+xml" rel="alternate" title="kairnsの记事簿 Categories Atom Feed" />
        
</head>
<body onblur="leavePage()" onfocus="comebackPage()">
    <div class="pages">
        <ul>
            <li class="home"><a href="/index.html">Home</a></li>
            <li ><a href="/pages/about-me.html">About Me</a></li>
            <li ><a href="/pages/Python_Packages_2012_11_05_12_18.html">Python Packages</a></li>
        </ul>
    </div>

<div class="hp-header-inner">
    <div class="page-header">
        <div class="content-header">
            <div id="title-block">
            <h1>  <a href="/2015/Flask_Web_Development_2015_04_25_00_26.html" rel="bookmark"
                    title="Permalink to Flask Web Development(7)">Flask Web Development(7)</a></h1>
            </div>
        </div>
    </div>
</div>
    <div class="content">
        <div class="data-holder">
        <div class="row">
           <div class="large-9 content-column column">
<div class="content-article">
    <header class="header-article">
        <div class="read-more">Posted on Sat 25 April 2015</div>
 
   </header>
    <section class='article'>
        
        <div class="entry-summary">
            <p>第7章 大型应用程序架构</p>
        </div>
    
        <div class="entry-content">
            <h2>《Flask Web Development》--第7章 大型应用程序架构</h2>
<p>把一个小应用程序的代码都放在一起会很方便，但是不利于扩展，尤其当项目开始变大时在一个文件中工作就会带来一些问题。不像其他框架，Flask应用程序没有特定的组织方式，选择权完全交给了使用者。本章会介绍一种按照包和模块来组织大型应用程序的方法，并会在本书剩余的章节都采用这种结构。</p>
<h3>项目结构</h3>
<p>一个Flask应用程序的布局：</p>
<div class="highlight"><pre>|-flashy
  |-app/
    |-templates/
    |-static/
    |-main/
      |-__init__.py
      |-errors.py
      |-forms.py
      |-views.py
    |-__init__.py
    |-email.py
    |-models.py
  |-migrations/
  |-tests/
    |-__init__.py
    |-test*.py
  |-venv.
  |-requirements.txt
</pre></div>


<p>顶级有四个文件夹，分别是：</p>
<ul>
<li>Flask应用程序所在的包通常被命名为app</li>
<li>数据库迁移相关的脚本被放置在migration</li>
<li>单元测试写在在tests</li>
<li>venv包含了Python的虚拟环境</li>
</ul>
<p>同样，增加了一些新的文件：</p>
<ul>
<li>requirements.txt 列举了依赖的包方便在新的电脑中对虚拟环境快速进行配置</li>
<li>config.py 存储了应用程序的配置参数</li>
<li>manage.py 用于启动应用程序以及做一些其他任务</li>
</ul>
<p>为了更好地理解这样的布局方式，后面的部分会介绍如何从一个只有hello.py的程序扩展到上图所示的结构。</p>
<h3>配置选项</h3>
<p>应用程序需要一些配置，比如对于开发、测试、产品会需要不同的数据库那样才不会相互影响。和单文件版本中在<em>hello.py</em>中写所有的配置不同，我们能够用类层级的方式来组织配置：</p>
<p><em>config.py</em>: 
Application configuration</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;hard to guess string&#39;</span> 
    <span class="n">SQLALCHEMY_COMMIT_ON_TEARDOWN</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">FLASKY_MAIL_SUBJECT_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;[Flasky]&#39;</span>
    <span class="n">FLASKY_MAIL_SENDER</span> <span class="o">=</span> <span class="s1">&#39;Flasky Admin &lt;flasky@example.com&gt;&#39;</span> 
    <span class="n">FLASKY_ADMIN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASKY_ADMIN&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">):</span> 
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span> <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s1">&#39;smtp.googlemail.com&#39;</span>
    <span class="n">MAIL_PORT</span> <span class="o">=</span> <span class="mi">587</span>
    <span class="n">MAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIL_USERNAME&#39;</span><span class="p">)</span>
    <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIL_PASSWORD&#39;</span><span class="p">)</span> 
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEV_DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data-dev.sqlite&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestingConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span> 
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEST_DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \ <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data-test.sqlite&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data.sqlite&#39;</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;development&#39;</span><span class="p">:</span> <span class="n">DevelopmentConfig</span><span class="p">,</span>
    <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="n">TestingConfig</span><span class="p">,</span>
    <span class="s1">&#39;production&#39;</span><span class="p">:</span> <span class="n">ProductionConfig</span><span class="p">,</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">DevelopmentConfig</span>
<span class="p">}</span>
</pre></div>


<p>Config基类包含了对所有配置通用的设置，不同的配置子类则定义了特有的设置。随需求变更还能增加其他配置子类。</p>
<p>为了让配置更灵活、安全，一些配置参数可以从环境变量中导入，比如SECRET_KEY考虑到安全性，可以存储在环境变量中，并且在配置脚本中提供了一个默认值以防环境变量没有设置它。</p>
<p>在三套不同的配置中，SQLALCHEMY_DATABASE_URI被赋予了不同的值，这样运行在三套不同配置下的应用程序都使用了不同的数据库。</p>
<p>配置类定义了类方法<code>init_app()</code>，它接受一个应用程序实例作为参数。这样特殊的配置就能够执行了（<code>注：原文是 Here configuration-specific initialization can performed 没明白init_app()这个方法跟特殊配置起不起作用有什么关系，至少在本章中的例子中没有体现出来</code>）。当前，仅Config类实现了一个空的<code>init_app()</code>方法。</p>
<p>在配置文件的底部不同的配置被添加到了字典中，并且开发环境的配置被设置成了默认的。</p>
<h3>应用程序包App</h3>
<p>应用程序包app是所有应用程序代码、模板、静态资源文件存放的地方，当然你也可以根据项目需求取别的名字。模板和资源文件的文件夹都被放入了app中，数据库对应的models和邮件支持功能模块则分别对应<em> app/models.py</em> 和 <em>app/email.py</em>。</p>
<h3>使用工厂方法来构建应用示例</h3>
<p>在单文件版本中创建应用程序实例很方便，但是通常会有缺陷。因为应用程序实例在全局作用于下被创建，而实例被创建后是没办法动态修改配置的。 尤其在做单元测试时，因为要跑不同的数据库，所以我们要应用不同的配置。</p>
<p>解决办法就是通过使用工厂方法延迟应用程序实例的创建，这样不仅仅是延迟了创建时间还让脚本有创建多个应用程序实例的能力，这对于测试尤其有用。</p>
<p>app包导入了Flask目前会用到的扩展，但因为应用程序实例还没有被构建出来，它们都还没有被正确初始化。<code>create_app()</code>这个工厂方法接受一个配置名称作为参数，通过使用Flask提供的app.config的<code>from_object()</code>方法，我们就能从<em>config.py</em>中导入所需要的配置。一旦应用程序实例被创建出来，扩展就能够通过调用<code>init_app()</code>来完成初始化。</p>
<p><em>app/<strong>init</strong>.py</em>: 
Application package constructor</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span> 
<span class="kn">from</span> <span class="nn">flask.ext.bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span> 
<span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Mail</span>
<span class="kn">from</span> <span class="nn">flask.ext.moment</span> <span class="kn">import</span> <span class="n">Moment</span>
<span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span> 
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">()</span>
<span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span> 
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">])</span> 
    <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">moment</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c1"># attach routes and custom error pages here</span>

    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>工厂方法返回的应用程序实例还不完整，因它们没有包含路由和错误处理功能，下一节会介绍如何解决这个问题。</p>
<h3>使用Blueprint来实现应用程实例的功能</h3>
<p>用工厂方法构建应用程序实例会给路由设置带来一些麻烦。单脚本应用中，应用程序实例是全局的，路由能简单地用app.route decorator来定义。但是现在应用程序实例是运行时创建的，app.route decorator只在在create_app()以后才存在，除此之外app.errorhandler decorator也有同样的问题。</p>
<p>Flask提供的解决方案是使用blueprints来解决这个问题。blueprints跟application类似，也能定义路由。不同之处是它的路由都处于休眠状态，直到它被注册到应用程序实例后路由才是它的一部分。</p>
<p>blueprint在全局作用域下使用，因此我们完全可以像在单文件中那样使用路由。当然你既能通过单文件也能通过更加组织良好的方式。为了达到最大程度的便利性，一个子包结构被创建用于管理blueprint。Example 7-4展示了在这个main包中如何创建blueprint：</p>
<p><em>app/main/init.py</em>: 
Blueprint creation</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span> 
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span><span class="p">,</span> <span class="n">errors</span>
</pre></div>


<p>blueprints被创建为Blueprint的实例对象，构造函数有两个参数：blueprint的名字和它所在的模块或者包，在这个应用程序中，Python的 __name__ 变量就是第二个参数所需要的值。</p>
<p>应用程序的路由被存储在app/main/views.py模块中， 错误处理则在app/main/errors.py。导入这些模块以后，路由和错误处理就和blueprint关联起来了。</p>
<p>有一点要注意路由和错误处理模块是在app/__init__.py的底部被导入的，因为<em>views.py </em>和 <em>errors.py</em>要导入main blueprint，所以为了避免循环依赖我们要等到main被创建出来才能够导入路由和错误处理。</p>
<p>blueprint在<code>create_app()</code>方法内被注册到应用程序实例中：</p>
<p><em>app/<strong>init</strong>.py</em>: 
Blueprint registration</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span> 
    <span class="c1"># ...</span>
    <span class="kn">from</span> <span class="nn">main</span> 
    <span class="kn">import</span> <span class="nn">main</span> <span class="kn">as</span> <span class="nn">main_blueprint</span>      
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">main_blueprint</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<h3>错误处理</h3>
<p><em>app/main/errors.py</em>: 
Blueprint with error handlers</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span> 
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">main</span>

<span class="nd">@main.app_errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> 
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>

<span class="nd">@main.app_errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> 
<span class="k">def</span> <span class="nf">internal_server_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;500.html&#39;</span><span class="p">),</span> <span class="mi">500</span>
</pre></div>


<p>在blueprint使用错误处理，如果使用<code>@app.errorhandler</code>，只有由blueprint定义的路由中导致的错误才会触发对应的handler，如果想要错误处理对整个应用程序可用，我们需要使用<code>@main.app_errorhandler</code>。</p>
<h3>使用blueprint方式的路由</h3>
<p><em>app/main/views.py</em>: 
Blueprint with application routes</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">main</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">NameForm</span> 
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@main.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span> 
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;.index&#39;</span><span class="p">))</span> 
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                           <span class="n">known</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;known&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
                           <span class="n">current_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
</pre></div>


<p>在blueprint中使用视图方法跟之前有两个不同的地方。第一个是route是来自blueprint，即-使用<code>@main.route</code>，第二个是<code>url_for()</code>方法的使用。在前面介绍过<code>url_for()</code>的参数默认是视图方法的名称，比如在单脚本应用中<code>index()</code>这个视图方法的URL能够通过<code>url_for('index')</code>获取到。</p>
<p>在blueprints中区别在于所有的作用域都来自于blueprint（作用域就是blueprint的名称，即Blueprint构造函数的第一个参数），因此<code>index()</code>视图方法需要通过<code>main.index</code>来获取到URL，即<code>url_for('main.index')</code>。<code>url_for()</code>方法同样支持参数的更短形式，通过将blueprint名字省略，我们可以简写为<code>url_for('.index')</code>。当然如果跨越不同的blueprints，blueprint的名字还是要加上的。</p>
<p>为了完成应用程序，我们还需要在<em>app/main/forms.py</em>模块导入form相关的一些对象。</p>
<h3>启动脚本</h3>
<p>在顶层文件夹下的<em>manage.py</em>是用来启动application的：</p>
<p><em>manage.py</em>: 
Launch script</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>
<span class="kn">from</span> <span class="nn">flask.ext.script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">flask.ext.migrate</span> <span class="kn">import</span> <span class="n">Migrate</span><span class="p">,</span> <span class="n">MigrateCommand</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FLASK_CONFIG&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span> 
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span>

<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="n">Shell</span><span class="p">(</span><span class="n">make_context</span><span class="o">=</span><span class="n">make_shell_context</span><span class="p">))</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> 
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>该脚本首先创建应用程序实例，然后从系统环境中读取<code>FLASK_CONFIG</code>变量，如果该变量没有定义则使用默认值。然后<code>Flask-Script</code>, <code>Flask-Migrate</code>等扩展的实例都被初始化。为了方便在Unix-based系统下运行我们增加了第一行。</p>
<h3>Requirements文件</h3>
<p>Applications应该包含一个<em>requirements.txt</em>，它记录了有着准确版本号的所有包依赖，这对以在其他电脑上初始化项目环境很重要。通过如下命令能够自动生成一个项目用到的包的<em>requirement.txt</em>文件：</p>
<div class="highlight"><pre>(venv) $ pip freeze &gt;requirements.txt
</pre></div>


<p>在一个新的环境中，你如果要复制虚拟环境中的安装包，只需要执行如下命令即可：</p>
<div class="highlight"><pre>(venv) $ pip install -r requirements.txt
</pre></div>


<p>该书示例中的requirement.txt中的包可能有一些已经过时了，你可以选择更加新版的包。如果因此遇到了什么问题，只要回退到老版本即可，因为老版本的都是通过了测试和应用程序兼容的。</p>
<h3>单元测试</h3>
<p>到目前应用程序还很小，几乎还没有什么要测试的，我们先来写一个小的测试例子：</p>
<p><em>tests/test_basics.py</em>: 
Unit tests</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span> 
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">BasicsTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="s1">&#39;testing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> 
        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_app_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_app</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_app_is_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">])</span>
</pre></div>


<p>测试是按照Python包中的典型的单元测试的写法来构建的，<code>setUp()</code> 和 <code>tearDown()</code> 方法在每个测试方法执行前后都会运行，任何以<code>test_</code> 开头的方法都会被当做测试方法来执行。关于使用Python包来做单元测试的更多信息可以查看official documentation。</p>
<p><code>setUp()</code>方法创建了测试所需的环境， 他首先创建了应用程序实例用作测试的山下文环境，这样就能确保测试拿到current_app, 然后新建了一个全新的数据库。数据库和应用程序实例最后都会在<code>tearDown()</code> 方法被销毁。</p>
<p>第一个测试确保了应用程序实例是存在的，第二个测试应用程序实例在测试配置下运行。为了确保测试文件夹有正确的包结构，我们需要添加一个<em>tests/<strong>init</strong>.py</em>文件（注：涉及Python包相关知识），这样单元测试包就能扫描所有在测试文件夹中的模块了。</p>
<p>你可以把代码checkout到7a的历史节点，并且执行 pip install -r requirements.txt 来确保你安装了所需要的包。为了运行测试用例，还需要添加命令到manage.py中：</p>
<p><em>manage.py</em>: 
Unit test launcher command</p>
<div class="highlight"><pre><span class="nd">@manager.command</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run the unit tests.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">unittest</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">)</span> 
    <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
</pre></div>


<p><code>manager.command decorator</code>所对应的方法名字就是命令的名字，并且方法的文档信息会被显示在help中，<code>test()</code> 的实现调用了unittest package包的<code>test runner</code>。如下是运行过程：</p>
<div class="highlight"><pre>(venv) $ python manage.py test
test_app_exists (test_basics.BasicsTestCase) ... ok
test_app_is_testing (test_basics.BasicsTestCase) ... ok
.----------------------------------------------------------------------
Ran 2 tests in 0.001s
OK
</pre></div>


<h3>数据库设置</h3>
<p>重构后的应用程序使用了跟单文件本版本中完全不同的数据库。数据库URL会首先从环境变量中获取，然后把默认的SQLite数据库作为备选，在三个配置环境下数据库的名字是不同的。</p>
<p>不论数据库的URL是什么，只要是转换到一个新的数据库数，据库表一定要被重新创建（<code>注：原文Regardless of the source of the database URL, the database tables must be created for the new database 不完全理解</code>）。使用Flask-Migrate进行迁移管理的过程中，数据库表能够通过如下命令被新建或者upgrade：</p>
<div class="highlight"><pre>(venv) $ python manage.py db upgrade
</pre></div>


<p>第一部分的内容到此算是结束了，我们已经基本介绍了使用Flask来创建应用程序的所有知识，但是你也许仍旧不确定如何将他们捏合在一起。第二部分的目标就是帮助你完成一个应用程序的开发。</p>
        </div>
    </section>
    <footer class="footer-article">
        <div class="tags-and-categories">Filed under <a href="/category/pydev.html">pyDev</a>
        | Tagged: <a href="/tag/flask.html">Flask </a><a href="/tag/python.html">Python </a><a href="/tag/web.html">Web </a>
        | <a href="/2015/Flask_Web_Development_2015_04_25_00_26.html" rel="bookmark"
         title="Permalink to Flask Web Development(7)">Permalink</a>            
        </div>
        <!-- metaldata 
        -->
    </footer>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript" src="/theme/js/disqus.js"></script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
            
            
			<div class="large-3 aside column">
				<img class="headIcon-large avatar" src="/sys_img/head.jpg" alt="(┬＿┬)">
                <h2>魏凯</h2>
                <h3>kairns leeky</h3>
				<a href="mailto:kai_kai03@hotmail.com?subject=%20&body=from%20blog"><Email>kai_kai03@hotmail.com</Email></a>
            </div>
            
            
			
			<div class="large-3 aside column">
                <h3>Socials</h3>
                <ul>
                    <li><a href="http://weibo.com/mipamipami">新浪weibo</a></li>
                    <li><a href="https://plus.google.com/105166364351021934050">g+</a></li>
                </ul>
            </div> 
            
            <div class="large-3 category-column column">
                <h3>Categories</h3>
                <ul>
                    <li><a href="/category/bu-kao-pu-chan-pin-ri-ji.html">不靠谱产品日记</a> (25)</li>
                    <li><a href="/category/db.html">DB</a> (3)</li>
                    <li><a href="/category/idev.html">iDev</a> (14)</li>
                    <li><a href="/category/machinelearning.html">MachineLearning</a> (23)</li>
                    <li><a href="/category/musical.html">Musical</a> (3)</li>
                    <li><a href="/category/other.html">other</a> (3)</li>
                    <li class="active"><a href="/category/pydev.html">pyDev</a> (19)</li>
                    <li><a href="/category/yin-shi-pin.html">音视频</a> (18)</li>
                </ul>
            </div> 
            
            <div class="large-3 category-column column">
                <h3>Feeds</h3>
                <ul>
                    <li ><a href="/feeds/all.atom.xml" type="application/atom+xml">Atom Feed</a></li>
                    <li ><a href="/feeds/all.rss.xml" type="application/rss+xml">RSS Feed</a></li>
                </ul>
            </div>
            
        
        

                <!--
            <iframe width="100%" height="600" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=600&fansRow=1&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=1&isFans=0&uid=1819436507&verifier=4060feb2&colors=fc1f12,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>            </div>
            -->
         
    </div>
</div>
    <div class="footer">
        <div class="data-holder">
        <div class="row">
            <div class="large-3 column">
<div class="Verse">
    <h3>bo主偈语</h3>
    <p>これも欲しい</p>
    <p>あれも欲しい</p>
    <p1>金がなくて悲しい</p1>
    <p>これもセール</p>
    <p>あれもセール</p>
    <p1>全部買うと責められる</p1>
    <p>これかっこい</p>
    <p>あれも可愛い</p>
    <p1>買えないので悔しい</p1>
    <p>いつ金が入る？</p>
    <p>いつ金が入る？</p>
    <p1>あの時まだ間に合う？</p1>
    <p>phaも買った</p>
    <p>hmzも買った</p>
    <p>嬉しいけど.....</p>
    <p1>土しか食べられるものは無かった</p1>
    <p1>嗯...2015年...vps不续费了...</p1>
</div>           </div>
           <div class="large-6 tag-cloud column">
                <h3>Tags</h3>
                <ul class="tagcloud">
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/nao-dong.html">脑洞
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/chord.html">Chord
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/websocket.html">WebSocket
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/mongo.html">mongo
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/classification.html">classification
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/shi-xu-tu.html">时序图
                        </a></li>
                    <li>
											<span class="badge">30</span>
                        <a href="/tag/chan-pin.html">产品
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/fuck.html">fuck
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/gc.html">GC
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/rtmp.html">RTMP
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/unicode.html">unicode
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/dylib.html">dylib
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/protocol.html">protocol
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/pycon.html">PyCon
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/cai-ji.html">采集
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/clustering.html">clustering
                        </a></li>
                    <li>
											<span class="badge">7</span>
                        <a href="/tag/web.html">Web
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/yi-zhi.html">移植
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/network.html">network
                        </a></li>
                    <li>
											<span class="badge">6</span>
                        <a href="/tag/flask.html">Flask
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/review.html">review
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/nodejs.html">Node.js
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/pep.html">PEP
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/linear.html">Linear
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/features.html">Features
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/wu-tai.html">舞台
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/cnn.html">CNN
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/pca.html">PCA
                        </a></li>
                    <li>
											<span class="badge">7</span>
                        <a href="/tag/webrtc.html">webRtc
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/css.html">CSS
                        </a></li>
                    <li>
											<span class="badge">8</span>
                        <a href="/tag/object-c.html">Object-C
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/memory.html">Memory
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/life.html">life
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/flask-socketio.html">Flask-SocketIO
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/http.html">HTTP
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/finance.html">finance
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/dataprocessing.html">DataProcessing
                        </a></li>
                    <li>
											<span class="badge">18</span>
                        <a href="/tag/python.html">Python
                        </a></li>
                    <li>
											<span class="badge">6</span>
                        <a href="/tag/javascript.html">JavaScript
                        </a></li>
                    <li>
											<span class="badge">18</span>
                        <a href="/tag/ios.html">iOS
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/encode.html">encode
                        </a></li>
                    <li>
											<span class="badge">2</span>
                        <a href="/tag/xcode.html">xCode
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/appstore.html">appstore
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/html5.html">html5
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/liu-cheng.html">流程
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/uiimage.html">UIImage
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/decorator.html">Decorator
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/ipad.html">iPad
                        </a></li>
                    <li>
											<span class="badge">5</span>
                        <a href="/tag/c.html">C++
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/jia-gou.html">架构
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/ffmpeg.html">FFmpeg
                        </a></li>
                    <li>
											<span class="badge">21</span>
                        <a href="/tag/algorithm.html">algorithm
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/database.html">database
                        </a></li>
                    <li>
											<span class="badge">16</span>
                        <a href="/tag/ml.html">ML
                        </a></li>
                    <li>
											<span class="badge">4</span>
                        <a href="/tag/yan-zou.html">演奏
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/framework.html">framework
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/gbk.html">GBK
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/rfc.html">rfc
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/cache.html">cache
                        </a></li>
                    <li>
											<span class="badge">19</span>
                        <a href="/tag/math.html">Math
                        </a></li>
                    <li>
											<span class="badge">3</span>
                        <a href="/tag/audio.html">audio
                        </a></li>
                    <li>
											<span class="badge">1</span>
                        <a href="/tag/obs.html">OBS
                        </a></li>
                </ul>
            </div>

            <div class="large-3 aside column">
                <h3>Links</h3>
                <ul>
                    <li><a href="http://mikanani.me/">蜜柑计划</a></li><br/>
                    <li><a href="http://josh.agarrado.net/music/anime/index.php">ジョシュの楽譜集</a></li><br/>
                    <li><a href="http://deeplearning.stanford.edu/">Deep Learning</a></li><br/>
                    <li><a href="http://getpelican.com/">Pelican</a></li><br/>
                    <li><a href="http://python.org/">Python</a></li><br/>
                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li><br/>
                </ul>
                
            </div>

        </row>
        </div>
        <div class="row">
            <div class="small-12 column">
                <p style="font-size: 0.7em; text-align:center;">
                ∠( ᐛ 」∠)＿不会有人拉到这么下边的呀就算拉下来也不会去看的呀这么小的字也看不清的口牙！ ©2015.
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257347159'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1257347159%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
                <script type="text/javascript" src="/theme/js/analytics.js"></script>
                </p>
            </div>
        </div>
    </div>

    
</body>
</html>