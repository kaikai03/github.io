Title: webRtc 后台
Date: 2015-03-16 20:03
Modified: 2015-03-16 20:03
Category: 音视频
Tags: webRtc,Node.js,JavaScript,WebSocket
Slug: webRtc_2015_03_16_20_03
Authors: kai_kai03
Summary: 用NodeJs写一个非常简化的交互平台来进行信令交互

## 简要说明 ##
简单设立3个用户，第一个连接的是A，第二个是B，第三个是C，第四个理论不支持，但是不会出问题，只是会把C顶掉。

A用户相当于最先启动视频监听的，举例子说就类似聊天室开房间并在等待的。
BC用户可以与A建立通话，
既A可以同时与BC进行通话，而bc之间信息不通。

PS：当然通话功能靠前端的webRtc来提供，这个demo平台的作用仅仅用于brower间的握手信令转发。

	var WebSocketServer = require('websocket').server;
	var UUID = require('node-uuid');
	var events = require('events');
	var util = require('util');
	
	var express = require('express');
	var app = express();
	var server = require('http').createServer(app);
	var path = require("path");
	var log = console.log;
	
	//demo only support 3 user
	//first connect user == A, and so on
	var userA = {};
	var userB = {};
	var userC = {};
	
	//websocket用50000端口
	var port = process.env.PORT || 50000;
	server.listen(port);
	app.use(express.static(__dirname));
	
	app.get('/', function(req, res) {
		res.sendfile(__dirname + '/test.html');
	});
	
	//init websocket
	var thisServer = new WebSocketServer({
		httpServer: server
	});
	

	//the callback of socket
	thisServer.on('connection', function(socket) {
		log('connection');
	});

	//confirm the code of user and information transfer
	//AtoB or AtoC or CtoA or BtoA 
	thisServer.on('request', function(request) {
		//log('request',request);
		console.log((new Date()) + ' Connection from origin ' + request.origin + '.');
		var connection = request.accept(null, request.origin);
		console.log((new Date()) + ' Connection accepted.');
		
		if(userA['connection']&& userB['connection']) {
			userC['connection'] = connection;
				userC['connection'].on('message', function(message){
					if (message.type === 'utf8') {
						log('this is C:',message.utf8Data);
							userA['connection'].sendUTF(message.utf8Data);
						} else {
							log('C:get2 a:',message.utf8Data);
						}
			});
				// tell brower:"you are A"
				userC['connection'].sendUTF(JSON.stringify( { "event": "_usersesion", "data": "c" } ));
				return;
			}
		
		if(userA['connection']) {
				userB['connection'] = connection;
				userB['connection'].on('message', function(message){
					if (message.type === 'utf8') {
						log('B:get2 a:',message.utf8Data);
						userA['connection'].sendUTF(message.utf8Data);
						} else {
						log('B:get2 2a:',message.utf8Data);
						}
			});
			// tell brower:"you are B"
			userB['connection'].sendUTF(JSON.stringify( { "event": "_usersesion", "data": "b" } ));
		}else{
				userA['connection'] = connection;
				userA['connection'].on('message', function(message){
					if (message.type === 'utf8') {
						try{
				  		var json = JSON.parse(message.utf8Data);
				  	}catch(e){
				  		console.log('is no json');
				  		console.log(message.utf8Data);
				  		return;
				  	}
				  	
				  	if(json.data.remoteSession === "c"){
							log('A:get C:',message.utf8Data);
							userC['connection'].sendUTF(message.utf8Data);
			    	}else{
			    		log('A:get2 b:',message.utf8Data);
							userB['connection'].sendUTF(message.utf8Data);
			    	}
				  	
					} else {
						log('A:get2 2b:',message.utf8Data);
						}
					});
					// tell brower:"you are A"
					userA['connection'].sendUTF(JSON.stringify( { "event": "_usersesion", "data": "a" } ));
		}
	
		
	});