Title: GPS纠偏
Date: 2012-03-06 17:47
Modified: 2012-03-06 17:47
Category: iDev
Tags: C,Object-C,algorithm,iOS
Slug: GPS_2012_03_06_17_47
Authors: kai_kai03
Summary: 为了应付一个国家课题验收临时解决方案

## 前情 ##
某在android做的国家课题进入验收阶段。因内容与交通有关，有一个项目是路测。

但问题来了，手机在路面上跑的时候，GPS受影响挺大的，虽然很多时候可以接受，但由于项目本身的需求，处理的数据量很大，并且不间断。在大压力计算的情况下，GPS会飘得非常厉害（也许是过热导致天线异常）。

so，他们来找我做个纠偏算法来骗过评审。

啊喂，关我屁事啊，android组的工作往我这边扔算啥，连作弊都不会搞毛啊.....

## 实现思路 ##
最后卖个人情还是给做吧。

仔细想想，其实非常简单，路线规划出来是之后是确定的，只要行径路线的卷积后的导数与线路函数（分段）求导，导数差在一定范围内，就认为在线路上。卷积权重与时间、与路程、与gps跳动幅度相关。当然这么做会导致真正的转向延迟展现，这个小问题嘛，太容易口头糊弄过去了。留给他们想口径吧。

确定是否真在线路上了，然后就是把偏移的点画到线上，这其实是一个高中问题：线段外一点求垂足的问题。

这里还有个问题：从图商拿回来的线路数据是由一小段一小段的离散数据组成，不光顺序不确定，小线段之间还有重叠，无序，前后颠倒，甚至在数据上还会出现“间断”，虽然视觉上看是一条线，但实际上只是“太粗”看不出来问题。

于是在做这里还要对线路数据进行预处理：首先起点终点位置是固定的，先拿出这两个小线段，然后对所有线段求导，按照方向归类，接着按照“位置”关系排序，把小线段按排序结果抽出来，中间如果发生大数据跳跃，就去其他方向“类”里从“两端”找衔接线段。形象的来说就是由起点终点“生长”出来的线，最终在中间碰头，连上。最后，再在间断部分插值补全。

最开始想用高斯让数据变得平滑，写了一半突然发现没多大意义，因为为了后面的效率，我需要把角度变化不大的连续的点用一个直线方程来表示。

为什么不用曲线和法线来做，还是因为效率，涉及到曲线拟合和指数运算，且用效果上来说其实差别不大。

生成一系列直线方程组后，提前对方程求导，算好斜率，接下来就等着gps给真实位置了。

gps作为线外点出现时，利用导数的负导数与gps点联立，得到垂直于路线的方程，再与路线联立，就得到映射点。

整个过程就完成了。当然这里面还有很多细节，例如转向、小夹角转向、回形针型线路，高架原盘等特殊情况的控制。这里就不一一赘述了。

## 结尾 ##
因为手上现成的环境只有xcode，于是为了调试方便就在iOS上做了，当然是用c写，否则后面有麻烦。

明天还要搭个交叉编译环境出个so给android同事。

代码就不贴了，怎么说也算商业代码。

其实很多事情并没有那么复杂，用过去小时候学的知识就能解决，并不是学校教的没用，仅仅只是不知道怎么用罢了。另外一个侧面说明是当时没学透，不会学以致用。