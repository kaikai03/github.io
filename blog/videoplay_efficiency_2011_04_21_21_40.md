Title: 软解视频，播放卡顿
Date: 2011-04-21 21:40
Modified: 2011-04-21 21:40
Category: iDev
Tags: ffmpeg,Object-C,iOS
Slug: videoplay_efficiency_2011_04_21_21_40
Authors: kai_kai03
Summary: 解决软解视频播放卡顿的问题

##软解视频卡顿的总结

&#160; &#160; &#160; &#160;大约两天前完成rtps的握手及rtp包拆解和重组，这两天调试过程就一个字！卡！<br>
&#160; &#160; &#160; &#160;调试过程使用的设备是iPhone3，iOS4.2.1，320*240的标准h264，播放时fps常会降到个位数。整个视频播放过程，画面有严重的卡顿。并且画面上自带的时间变化逐渐渐慢。<br>

&#160; &#160; &#160; &#160;1，认为是绘图效率，于是把视频绘制层及相关逻辑注释掉，去操作app其他功能。依然有卡顿感。那么已经排除绘图效率问题。<br>


&#160; &#160; &#160; &#160;2，ffmpeg效率问题？改了些解码参数，打开nano，虽然估计也没啥用，反正不管怎么调都没有起色，于是跳过，毕竟ffmpeg深层的效率问题我估计公司也出不起这成本去深究。

&#160; &#160; &#160; &#160;3，最后我把目光抛向rtp的拆包组包上。<br>
&#160; &#160; &#160; &#160;花了点时间，在各个业务关键点上加入一个全局的耗时统计功能，日志一看，我艹，h264裸数据组包、进栈、出栈，这一套流程占用了cpu的70%运算时间。<br>
&#160; &#160; &#160; &#160;又用了一个下午来进一步检查这部分实现逻辑，并没有问题，查了不下10遍啊喂...我开始怀疑这个世界.....哦不，是这个系统，难道是objc数据对象的效率问题？<br>
&#160; &#160; &#160; &#160;反正业务逻辑已经整理完写过一遍了，重写也用不了多少时间，于是花了半天用c把这部分重新实现一般。果不其然，objc对象的效率有很严重的问题！！！用c重写后，这部分的运算时间占用降低到30%，解码和绘图占用时间比例上升。<br>

&#160; &#160; &#160; &#160;至此，软解h264卡顿的问题就解决了。

&#160; &#160; &#160; &#160;虽然再刚接触objc的时候就感觉它的这种消息机制会有一定上的执行效率浪费，但这次对数据流开发还是坚持用它，其原因是：*刚学会的东西当然要拿出来耍耍啊，是不......*

&#160; &#160; &#160; &#160;**总的来说就是：大量数据流操作不要用objc对象。**